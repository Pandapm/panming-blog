<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>使用Nightwatch进行E2E测试 | 椒图笔记</title>
  
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/zenburn.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div class="Shell">
    <aside class='SideBar'>
    <section class='avatar' style="background-image: url()">
        <div class='av-pic' style="background-image: url(/assets/cg.png)">
        </div>
    </section>
    <section class='menu'>
        <div>椒图笔记</div>
        
        <ul>
          
            <a href="/" class="Btn">
              <li>Home</li>
            </a>  
          
            <a href="/archives/" class="Btn">
              <li>Archive</li>
            </a>  
          
            <a href="/tags/" class="Btn">
              <li>Tags</li>
            </a>  
          
            <a href="/categories/" class="Btn">
              <li>Categories</li>
            </a>  
          
            <a href="/about/" class="Btn">
              <li>About</li>
            </a>  
          
        </ul>
    </section>
    <section class="media">
        
    </section>
</aside>

    <div class="container">
        <div data-pager-shell>
            <div>
  <article class='ContentView'>
    <header class='PageTitle'>
        <h1>使用Nightwatch进行E2E测试</h1>
    </header>

    <section>
      <p> <img src="http://nightwatchjs.org/img/cloud-banner.png" alt=""><br><a id="more"></a><br><a href="https://xiyoumobile.com/active_main.html#wiki73" target="_blank" rel="external">本文在线预览</a></p>
<h2 id="E2E测试"><a href="#E2E测试" class="headerlink" title="E2E测试"></a>E2E测试</h2><p>不同于行为驱动测试（BDD）和单元测试独立运行并使用模拟/存根，端到端测试将试着尽可能从用户的视角，对真实系统的访问行为进行仿真。对Web应用来说，这意味着需要打开浏览器、加载页面、运行JavaScript，以及进行与DOM交互等操作。<br>然而，项目在快速迭代中不可避免的要进行一遍又一遍测试，费时又费力，而且极有可能因人工失误忽略某些环节。再者，怎么能容忍一次搞定的事非要多次重复呢？不能忍啊。万能的程序员们总会有办法解决如此循环往复的重复性工作，于是，三年前的某个月黑风高的夜晚，Nightwatch诞生了（虽然这货最新的release版本是五天之前的v0.9.14）。</p>
<h2 id="Nightwatch-简介"><a href="#Nightwatch-简介" class="headerlink" title="Nightwatch 简介"></a>Nightwatch 简介</h2><p>Nightwatch.js是一个基于Node.js的端到端(e2e)测试方案，使用<a href="https://www.w3.org/TR/webdriver/" target="_blank" rel="external">W3C WebDriver API</a>，将Web应用测试自动化。它提供了简单的语法，支持使用JavaScript和CSS选择器，来编写运行在<a href="http://www.seleniumhq.org/" title="Selenium" target="_blank" rel="external">Selenium</a>服务器上的端到端测试。</p>
<p>Selenium相当于一个自动化的浏览器，是用于Web应用程序测试的工具。Selenium测试直接运行在浏览器中，就像真正的用户在操作一样。支持的浏览器包括IE、Mozilla Firefox、Mozilla Suite等（其实Selenium就是一个jar包）</p>
<blockquote>
<p>目前，Selenium是JavaScript的世界里验收测试方面最流行的工具之一，类似的还有PhantomJS。二者都有其独到的方法：Selenium使用其WebDriver API，而PhantomJS使用无界面的WebKit浏览器。它们都是非常成熟的工具，都具有强大的社区支持。它们与Nightwatch之间最大的不同，主要是在于语法的简易度以及对持续集成的支持。与Nightwatch相比，Selenium和PhantomJS都拥有更加冗长的语法，这会让编码变得更庞大，而且不支持从命令行中进行开箱即用的持续集成（JUnit XML或其他标准输出）。</p>
</blockquote>
<p>p.s. Selenium和PhantomJS都是可以单独作为一种测试方案，Nightwatch是基于Selenium的一种更简洁的测试方案。</p>
<p>p.s. WebDriver目前已经是W3C的一个规范，旨在规范浏览器的自动化行为</p>
<p>p.s. 我是咋知道有这么个东西的？其实是Vue全家桶里给带的。</p>
<p>Nightwatch工作时时依托于一套基于HTTP的REST API，只不过Server端不是传统意义上的后端，而是WebDriver的服务器（Selenium）,这套REST API是基于W3C WebDriver API的。<br>就像这样：</p>
<p><img src="http://nightwatchjs.org/img/operation.png" alt="work flow"></p>
<p>大部分的情况下，Nightwatch执行一条命令或者断言回响WebDriver发送两个请求，第一个请求用来获取到CSS或XPath选择器选中的那个element节点，第二个请求用来发送这条命令或者断言。</p>
<h2 id="Nightwatch的主要特点"><a href="#Nightwatch的主要特点" class="headerlink" title="Nightwatch的主要特点"></a>Nightwatch的主要特点</h2><ul>
<li>语法简洁干净</li>
<li>支持CSS选择器和XPath选择器，只要编写的测试用例符合规范，就无须再初始化其他对象和类。</li>
<li>内置命令行测试运行器，可以按组或单个运行测试。</li>
<li>可以持续集成</li>
<li>易扩展</li>
</ul>
<h2 id="在项目中使用Nightwatch"><a href="#在项目中使用Nightwatch" class="headerlink" title="在项目中使用Nightwatch"></a>在项目中使用Nightwatch</h2><p>先贴一个例子【这是用来测kz-fe中node-arch的首页的一个用例片段】<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="string">'default tests'</span>: <span class="function"><span class="keyword">function</span> (<span class="params">browser</span>) </span>&#123;</div><div class="line">      <span class="keyword">const</span> devServer = browser.globals.devServerURL;</div><div class="line"></div><div class="line">      browser</div><div class="line">        .url(devServer)</div><div class="line">        .waitForElementVisible(<span class="string">'body'</span>, <span class="number">2000</span>)</div><div class="line">        .assert.attributeContains(<span class="string">'body'</span>, <span class="string">'class'</span>, <span class="string">'directory'</span>) </div><div class="line">        .assert.elementPresent(<span class="string">'input'</span>) </div><div class="line">        .assert.attributeEquals(<span class="string">'#search'</span>, <span class="string">'placeholder'</span>, <span class="string">'Search'</span>) </div><div class="line">        .assert.cssProperty(<span class="string">'#search'</span>, <span class="string">'position'</span>, <span class="string">'fixed'</span>)</div><div class="line">        .assert.elementPresent(<span class="string">'#wrapper'</span>)</div><div class="line">        .end()</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>在项目中使用Nightwatch需要安装三个npm包：</p>
<ul>
<li>chromedrive</li>
<li>nightwatch</li>
<li>selenium-server</li>
</ul>
<p>然后需要一个配置文件：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "src_folders": ["test/e2e/specs"], // 放测试用例</div><div class="line">  "output_folder": "test/e2e/reports", // 放测试报告</div><div class="line">  </div><div class="line">  "selenium" : &#123;</div><div class="line">    "start_process" : true,</div><div class="line">    "server_path": "node_modules/selenium-server/lib/runner/selenium-server-standalone-3.3.1.jar",</div><div class="line">    "host": "127.0.0.1",</div><div class="line">    "log_path" : "",</div><div class="line">    "port" : 4444,</div><div class="line">    "cli_args" : &#123;</div><div class="line">      "webdriver.chrome.driver" : ""</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  "test_settings" : &#123;</div><div class="line">    "default" : &#123;</div><div class="line">        "launch_url" : "http://localhost",</div><div class="line">        "selenium_port"  : 4444,</div><div class="line">        "selenium_host"  : "localhost",</div><div class="line">        "silent": true,</div><div class="line">        "globals": &#123;</div><div class="line">            "devServerURL": "http://localhost:8080"</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    "chrome" : &#123;</div><div class="line">      "desiredCapabilities": &#123;</div><div class="line">        "browserName": "chrome",</div><div class="line">        "javascriptEnabled": true</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    "edge" : &#123;</div><div class="line">        xxxx略</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后就可以愉快地写测试用例了。</p>
<h2 id="Nightwatch-API"><a href="#Nightwatch-API" class="headerlink" title="Nightwatch API"></a>Nightwatch API</h2><p>Nightwatch API分为四个部分，分别是Expect、Assert、Commands、WebDriver Protocol</p>
<h3 id="Expect"><a href="#Expect" class="headerlink" title="Expect"></a>Expect</h3><p>Expect是0.7版本的时候引入的一种BDD（行为驱动测试）风格的接口，也是为了执行断言，使用链式的语法，和直接的断言相比，expect读起来更加语义化，就像写句子（但是单词之间用的.连接的）<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.demoTest = <span class="function"><span class="keyword">function</span> (<span class="params">browser</span>) </span>&#123;</div><div class="line">  browser.expect.element(<span class="string">'#main'</span>).to.be.present;</div><div class="line">  browser.expect.element(<span class="string">'#main'</span>).to.be.visible;</div><div class="line">  browser.expect.element(<span class="string">'#main'</span>).to.have.css(<span class="string">'display'</span>).which.does.not.equal(<span class="string">'block'</span>);</div><div class="line">  browser.expect.element(<span class="string">'#q'</span>).to.be.an(<span class="string">'input'</span>);</div><div class="line">  browser.expect.element(<span class="string">'body'</span>).to.not.have.attribute(<span class="string">'data-attr'</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>Expect提供的语言连词不直接进行断言（真正的断言是末尾的那个词），可以随意组合，顺序不影响结果。<br>to 、be 、been 、is 、that、which、and、has、have、with、at、does</p>
<h3 id="Assert"><a href="#Assert" class="headerlink" title="Assert"></a>Assert</h3><p>Assert这部分包含两套有同样方法的方法库：assert和verify,其中，若是当前执行的断言没有成功，assert会停止执行剩余的断言并立即结束，verify会打印错误日志然后继续淡定的执行接下来的断言。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">browser</div><div class="line">       .url(devServer)</div><div class="line">       .waitForElementVisible(<span class="string">'body'</span>, <span class="number">2000</span>)</div><div class="line">       .assert.attributeContains(<span class="string">'body'</span>, <span class="string">'class'</span>, <span class="string">'directory'</span>) <span class="comment">// 属性值</span></div><div class="line">       .assert.elementPresent(<span class="string">'input'</span>) <span class="comment">// 有当前元素</span></div><div class="line">       .assert.attributeEquals(<span class="string">'#search'</span>, <span class="string">'placeholder'</span>, <span class="string">'Search'</span>) <span class="comment">// 属性值</span></div><div class="line">       .assert.cssProperty(<span class="string">'#search'</span>, <span class="string">'position'</span>, <span class="string">'fixed'</span>) <span class="comment">// CSS属性值</span></div><div class="line">       .assert.elementPresent(<span class="string">'#wrapper'</span>)</div><div class="line">       .end()</div></pre></td></tr></table></figure>
<h3 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h3><p>Commands用来在页面上执行一些命令比如点击、关掉当前窗口、清除cookie、获取到某元素的值等。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.demoTest = <span class="function"><span class="keyword">function</span> (<span class="params">browser</span>) </span>&#123;</div><div class="line"></div><div class="line">  browser.click(<span class="string">"#main ul li a.first"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.assert.ok(browser === <span class="keyword">this</span>, <span class="string">"Check if the context is right."</span>);</div><div class="line">    <span class="keyword">this</span>.assert.ok(<span class="keyword">typeof</span> response == <span class="string">"object"</span>, <span class="string">"We got a response object."</span>);</div><div class="line">  &#125;);</div><div class="line">  browser.clearValue(<span class="string">'input[type=text]'</span>);</div><div class="line">  browser.pause(<span class="number">1000</span>);</div><div class="line">  browser.saveScreenshot(<span class="string">'/path/to/fileName.png'</span>);</div><div class="line">  browser.closeWindow();</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="WebDriver-Protocol"><a href="#WebDriver-Protocol" class="headerlink" title="WebDriver Protocol"></a>WebDriver Protocol</h3><p>很多，太多了，不说了。</p>
<p><a href="http://nightwatchjs.org/" target="_blank" rel="external">Nightwatch在线文档</a></p>


      

    </section>
    
      <section class='ArticleMeta'>
          <div>
            发布于&nbsp;
            <time datetime="2017-03-27T09:03:30.000Z" itemprop="datePublished">
              2017-03-27
            </time>
          </div>
          
            <div>
              tags: 
  <li class="meta-text">
  { <a href="/tags/测试/">测试</a> }
  </li>

  <li class="meta-text">
  { <a href="/tags/JavaScript/">JavaScript</a> }
  </li>


            </div>
          
      </section>
    
    
      <section>
        <div id="disqus_thread"></div>
        <script>
          window.disqus_config = function () {
            this.page.url = window.location.toString()
            this.page.identifier = window.location.pathname
          }
          if (typeof DISQUS === 'undefined') {
            (function() { // DON'T EDIT BELOW THIS LINE
              var d = document, s = d.createElement('script');
              s.src = 'https://.disqus.com/embed.js';
              s.setAttribute('data-timestamp', +new Date());
              (d.head || d.body).appendChild(s);
            })();
          } else {
            DISQUS.reset({
                reload: true,
                config: window.disqus_config
            })
          }
        </script>
      </section>
    
</article>

  
</div>

            <footer>
    <div>© 2016 - PM </div>
    <div>
    Powered by Hexo
    </div>
</footer>

        </div>
    </div>
</div>
<script src="/js/pager/dist/singlepager.js"></script>
<script>
var sp = new Pager('data-pager-shell')

</script>
</body>
</html>